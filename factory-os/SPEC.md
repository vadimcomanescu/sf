# Factory OS — Metaspec (Feb 2026)

Goal: A local-first software factory that can run **multiple products** concurrently, build/iterate/deploy them autonomously, and **verify itself**.

## A) Core capabilities
1) Multi-product workspace
- A “product” is a git repo + config.
- Products can run builds concurrently.
- Each run is an Attractor DOT pipeline executed by Kilroy.

2) WebUI (real time)
- List products, runs, stages.
- Stream logs/events live (SSE or WS).
- Show per-stage diffs and artifacts.
- Controls: start run, stop run, resume run.

3) CLI (`sf`)
- `sf product add|list|remove`
- `sf run start|status|stop|resume|logs`
- `sf pipeline validate|run` (wrapper over Kilroy)

4) Self-verification
- Deterministic verifiers: typecheck, lint, unit tests, integration tests.
- Holdout scenarios: hidden from coding agents, executed by eval harness.
- Acceptance gate is statistical (confidence bound) not just pass/fail.

5) Parallelism + convergence
- For a given task, generate K candidate branches in parallel.
- Screen by deterministic tests.
- Evaluate survivors on holdouts.
- Select winner via sequential halving / tournament.
- Merge only if acceptance bound met; otherwise iterate.

## B) Technology choices (few stacks to reduce drift)
Factory OS itself:
- TypeScript monorepo (pnpm + turbo)
- apps/web: Next.js
- apps/api: Fastify, DDD folders
- packages/core: run manager + adapters
- packages/evals: scenario runner + statistics
- Observability: OpenTelemetry (OTel) + local Grafana stack via docker compose (optional in v1, but instrumentation required)

Products generated by the factory:
STACK-TS (default): Next.js + TypeScript + Convex backend (agents like TS end-to-end; durable agent components exist).
STACK-PY (when needed): Next.js + FastAPI + Postgres (Supabase optional) on Fly.io.

Voice agents:
- Must support pluggable STT/TTS providers.
- Default local mode should run on RTX 3060: Whisper-family STT + local TTS (Piper or equivalent).
- Provide cloud fallbacks (Deepgram/ElevenLabs/OpenAI) but not required.

## C) Integration with Kilroy / Attractor
- Kilroy provides: ingest/validate/run/resume/status/stop and CXDB logging.
- Factory OS should call Kilroy as a subprocess and parse its structured artifacts from logs_root.
- CXDB UI can run locally and be linked from WebUI.

## D) Statistical acceptance gate (must implement)
Given N holdout checks with k passes:
- Compute conservative lower confidence bound (Clopper–Pearson) at alpha (default 0.05).
- Accept only if lower bound >= target (default 0.98), AND deterministic verifiers pass.
- Store evaluation artifacts per run.

## E) Pipeline-invariants (factory verifies itself)
- “Stop” must halt a run.
- “Resume” must continue from last checkpoint deterministically.
- Event stream must be well-formed (schema + monotonic timestamps).
- A smoke product pipeline must complete end-to-end and deploy in dry-run mode.

Deliver v1 as a working local system.
